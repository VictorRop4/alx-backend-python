#!/bin/bash
# Script: kubctl-0x03
# Objective: Perform Rolling Update with zero downtime.

set -e

DEPLOYMENT="django-blue"
NAMESPACE="default"
SERVICE_URL="http://127.0.0.1:8000"   # Replace with service or ingress URL

echo "🚀 Applying updated deployment (version 2.0)..."
kubectl apply -f blue_deployment.yaml -n "$NAMESPACE"

echo "⏳ Monitoring rollout status..."
kubectl rollout status deployment/"$DEPLOYMENT" -n "$NAMESPACE" --timeout=120s &

ROLL_PID=$!

# Test downtime while rollout happens
echo "⚡ Sending requests to check availability..."
for i in {1..30}; do
    if curl -s "$SERVICE_URL" > /dev/null; then
        echo "[$i] ✅ App responded successfully"
    else
        echo "[$i] ❌ App request failed"
    fi
    sleep 2
done

wait $ROLL_PID

echo "📊 Verifying pods after rolling update..."
kubectl get pods -l app=django,version=blue -n "$NAMESPACE" -o wide

echo "🎯 Rolling update complete!"

